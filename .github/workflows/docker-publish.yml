name: Docker Image CI Pipeline for Emulator and Generator

on:
  workflow_dispatch:
  push:
    tags: [ 'v*.*.*' ]
  
jobs:
  check-current-branch:
    runs-on: ubuntu-latest
    outputs:
      branch: ${{ steps.check_step.outputs.branch }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get current branch
        id: check_step
        # 1. Get the list of branches ref where this tag exists
        # 2. Remove 'origin/' from that result
        # 3. Put that string in output
        # => We can now use function 'contains(list, item)''
        run: |
          raw=$(git branch -r --contains ${{ github.ref }})
          branch="$(echo ${raw//origin\//} | tr -d '\n')"
          echo "branch=$branch" >> $GITHUB_OUTPUT
          echo "Branches where this tag exists : $branch."

  emulator_push_to_registry:
    needs: check-current-branch
    if: contains(needs.check-current-branch.outputs.branch, 'main')
    name: Emulator
    uses: oleksiygarnik/beter-testing-tools-2/.github/workflows/base-docker-publish.yml@main
    with:
      project_name: emulator
      image_name: docker.io/silencerdev/testingtools.emulator
      dockerfile_path: src/Beter.TestingTools.Emulator.Host/Dockerfile
      unit_tests_path: tests/Beter.TestingTools.UnitTests/Beter.TestingTools.UnitTests.csproj
      code_coverage_threshold: 0
    secrets:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_PASSWORD: ${{ secrets.DOCKERHUB_TOKEN }}
          
  generator_push_to_registry:
    needs: check-current-branch
    if: contains(needs.check-current-branch.outputs.branch, 'main')
    name: Generator
    uses: oleksiygarnik/beter-testing-tools-2/.github/workflows/base-docker-publish.yml@main
    with:
      project_name: generator
      image_name: docker.io/silencerdev/testingtools.generator
      dockerfile_path: src/Beter.TestingTools.Generator.Host/Dockerfile
      unit_tests_path: tests/Beter.TestingTools.UnitTests/Beter.TestingTools.UnitTests.csproj
      code_coverage_threshold: 0
    secrets:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_PASSWORD: ${{ secrets.DOCKERHUB_TOKEN }}
      
